<!DOCTYPE html>
<html>

<head>

<title> sIndent </title>

<link rel="stylesheet" type="text/css" href="extjs-4.1.0/resources/css/ext-all.css">
	
<script type="text/javascript" src="extjs-4.1.0/ext-all-debug.js"></script>

<script type='text/javascript'>

Ext.require([
	'Ext.data.*', 
	'Ext.grid.*', 
	'Ext.tree.*'
]);

Ext.onReady(function() {
	
});	

var root = {
	text: '.',
	expanded: true,
	leaf: false,
	children: []
};

var tree;
var nodeStack;

var indent = 0;

var timeRegex          = /\d\d:\d\d:\d\d\.\d\d\d/i;
var microsecondsRegex  = /\(\d\d*\)/i;
var categoryRegex      = /\|[^|]*/i;
var subcategoryRegex   = /\|\[\w*\]/i;
var objectIdRegex      = /\|[A-Z0-9]{15}\|/i;

function indentLog() {

	if (tree) {
		Ext.destroy(tree);
		tree = undefined;
	}

	delete root.children;
	root.children = [];
	nodeStack = [root];

	var input = document.getElementById('input').value;
	var lines = input.split('\n');
	var numOk = 0;

	indent = 0;
	line = 0;

	for (var i = 0; i < lines.length; i++) {

		var line = lines[i];

		if (timeRegex.test(line)) {
			indentLine(line);
			++numOk;
		}
	}

	if (indent !== 0)
	{
		alert('Error - Truncated Log? - indent not zero at end: ' + indent);
	}

	if (input && input.length > 0 && numOk === 0)
	{
		alert("Error - didn't understand the input.\n\nPaste a Salesforce Debug Log into the text-area.\n\nYou can paste a full Ctrl-A Ctrl-C copy of the whole Debug Log screen from your browser or from eclipse.");
	}

    tree = Ext.create('Ext.tree.Panel', {
        title: 'Log',
        width: 1000,
        height: 1000,
        renderTo: Ext.getBody(),
        collapsible: true,
        useArrows: true,
        multiSelect: true,
		lines: true,
        singleExpand: false,
		rootVisible: false,
		fields: ['text', 'time', 'microseconds', 'objectId', 'line', 'category'],
        columns: [{
            xtype: 'treecolumn',
            text: 'Text',
            flex: 11,
            sortable: true,
            dataIndex: 'text'
        }, {
            text: 'Category',
            flex: 4,
            sortable: true,
            dataIndex: 'category',
		}, {
			text: 'Line',
            flex: 1,
            sortable: true,
            dataIndex: 'line'
        }, {
			text: 'Time',
            flex: 2,
            sortable: true,
            dataIndex: 'time'
        }, {
			text: 'Microseconds',
            flex: 2,
            sortable: true,
            dataIndex: 'microseconds'
		}, {
			text: 'Object',
            flex: 2,
            sortable: true,
            dataIndex: 'objectId'
        }],
		root: root		
    });	
}

/**
 * Create a table row for the given line
 * @param {String} line the input line
 * @returns {HTMLTableRowElement} the created table row.
 */
function indentLine(line) {

	var node = {};

	node.leaf     = false;
	node.children = [];

	node.time         = format(timeRegex.exec(line));
	node.microseconds = format(microsecondsRegex.exec(line));
	node.category     = format(categoryRegex.exec(line));
	node.line         = format(subcategoryRegex.exec(line));
	node.objectId     = format(objectIdRegex.exec(line));

	line = line.replace(timeRegex, '');
	line = line.replace(microsecondsRegex, '');
	line = line.replace(categoryRegex, '');
	line = line.replace(subcategoryRegex, '');
	line = line.replace(objectIdRegex, '');

	if (line.trim().length === 0) {
		line = node.category;
	}
	
	node.text = format([line]);

	node.isEntry     = false;
	node.isExit      = false;
	node.isException = false;
	node.isDebug     = false;

	if (node.category.length > 0) {

		if (/METHOD_ENTRY|CONSTRUCTOR_ENTRY|DML_BEGIN|SOQL_EXECUTE_BEGIN|CODE_UNIT_STARTED|VF_DESERIALIZE_VIEWSTATE_BEGIN/.test(node.category)) {
			node.isEntry = true;
		}
		else if (/METHOD_EXIT|CONSTRUCTOR_EXIT|DML_END|SOQL_EXECUTE_END|CODE_UNIT_FINISHED|VF_DESERIALIZE_VIEWSTATE_END/.test(node.category)) {
			node.isExit = true;
		}
		else if (/EXCEPTION_THROWN|FATAL_ERROR/.test(node.category)) {
			node.isException = true;
		}
		else if (/USER_DEBUG/.test(node.category)) {
			node.isDebug = true;
		}
	}

	if (node.isEntry) {
		indent++;
		nodeStack[nodeStack.length - 1].children.push(node);
		nodeStack.push(node);
	}
	else if (node.isExit) {	
		indent--;
		var offNode = nodeStack.pop();
		
		if (offNode.children.length === 0) {
			offNode.leaf = true;
		}
		else {
			offNode.expanded = true;
		}
	}
	else {
		node.leaf = true;
		nodeStack[nodeStack.length - 1].children.push(node);
	}

	if (indent < 0) {
		node.text += " NEGATIVE INDENT ";
	}

	node.indent = indent;		
}

function format(resultsArray) {

	if (resultsArray && resultsArray[0]) {
		return cleanUp(resultsArray[0]);
	}
	else {
		return '';
	}
}

function cleanUp(text) {

	if (text === null || text === undefined) {
		return '';
	}

	return Ext.String.htmlEncode(text.replace(/\|/, '').replace(/\|$/, ''));
}

</script>

</head>

<body>

<div style='font-family:monospace; font-weight:bold;'>

sIndent - Salesforce Debug Log Indenter - <span style='color:#ccc'> Andy Hutchinson </span>

</div>

<textarea id='input' autofocus required cols='100' rows='5' wrap='hard' oninput='indentLog()'
 placeholder='Paste your log here... (You can paste the full contents of the salesforce debug log screen from your browser or from eclipse - i.e. Ctrl-A Ctrl-C then Paste)'></textarea>

</body>

</html>